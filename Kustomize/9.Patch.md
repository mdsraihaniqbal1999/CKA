# Kustomize Patches: A Detailed Guide ğŸš€

## ğŸ“Œ Overview
Kustomize patches allow you to modify Kubernetes manifests in a **surgical** way without altering the base files. They help customize configurations dynamically for different environments.

## ğŸ—ï¸ Types of Patches in Kustomize
| Patch Type | Description | Use Case |
|------------|-------------|----------|
| **Strategic Merge Patch** ğŸ©¹ | Uses the structure of the Kubernetes resource to apply modifications. | Best for modifying existing fields without affecting other fields. |
| **JSON 6902 Patch** ğŸ”§ | Uses JSON patch syntax (`add`, `remove`, `replace`). | Useful for fine-grained control of specific elements. |
| **Inline Patch** âœï¸ | Defined directly inside `kustomization.yaml`. | Best for small, quick modifications. |
| **Patch File** ğŸ“„ | Stored in a separate YAML file and referenced in `kustomization.yaml`. | Useful for larger or reusable patches. |

## âœ… When to Use Patches
- When you need **targeted modifications** without altering the original YAML files.
- When handling **environment-specific configurations** in overlays.
- When updating only **specific sections** of a resource.
- When avoiding **duplication** of Kubernetes manifests across different environments.
- When working with **complex Kubernetes resources** that require changes to deeply nested fields.

## âŒ When NOT to Use Patches
- If a **transformer** can achieve the modification (e.g., label changes, image updates).
- If the modification is **global** rather than targeted.
- If Helm provides a **better templating** alternative for the use case.
- If the patching process is **too complex**, making direct YAML edits more efficient.

---

# ğŸ”¥ Process to Create and Apply a Patch in Kustomize
### ğŸ“Œ Steps to Create a Patch
1. **Identify the Base Resource**: Locate the Kubernetes manifest that needs modifications.
2. **Choose a Patch Type**: Select **Strategic Merge Patch** or **JSON 6902 Patch**.
3. **Create the Patch File**: Define changes in YAML format.
4. **Reference the Patch in `kustomization.yaml`**: Ensure the patch is linked properly.
5. **Apply the Patch Using Kustomize**: Use `kubectl apply -k` to deploy.
6. **Validate the Changes**: Use `kubectl get` or `kubectl describe` to verify the updates.

### ğŸ“Œ Example Folder Structure ğŸ“‚
```
kustomize-patches/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”œâ”€â”€ overlays/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”œâ”€â”€ replicas-patch.yaml
â”‚   â”œâ”€â”€ prod/
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”œâ”€â”€ json-patch.yaml
```

## ğŸ“Œ Step 1: Create a Kind Cluster ğŸ—ï¸
```sh
cat <<EOF | kind create cluster --name=kustomize-patches --config=-
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
EOF
```

## ğŸ“Œ Step 2: Define Base Resources ğŸ“œ
```yaml
resources:
  - deployment.yaml
  - service.yaml
```

## ğŸ“Œ Step 3: Apply Different Types of Patches ğŸ¯

### âœ… Strategic Merge Patch Example ğŸ©¹
```yaml
patchesStrategicMerge:
  - replicas-patch.yaml
```
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 1
```

### âœ… JSON 6902 Patch Example ğŸ”§
```yaml
patches:
  - path: json-patch.yaml
    target:
      kind: Deployment
      name: nginx
```
```yaml
- op: replace
  path: /spec/replicas
  value: 5
```

---

# ğŸ“Œ Patches Dictionary ğŸ“–
| Patch Type | Operation | Example |
|------------|------------|------------|
| **Replace Dictionary JSON 6902** | Replace a value | `- op: replace` |
| **Add Dictionary JSON 6902** | Add a new value | `- op: add` |
| **Remove Dictionary JSON 6902** | Remove a value | `- op: remove` |
| **Replace Dictionary Strategic Merge** | Modify existing field | `replicas: 5` |
| **Add Dictionary Strategic Merge** | Add a new field | `labels: new-label` |
| **Remove Dictionary Strategic Merge** | Remove an existing field | `labels: null` |

---

# ğŸ“Œ Patches List ğŸ“‘
| Patch Type | Example |
|------------|------------|
| **Replace List JSON 6902** | `- op: replace path: /spec/template/spec/containers/0` |
| **Add List JSON 6902** | `- op: add path: /spec/template/spec/containers/-` |
| **Remove List JSON 6902** | `- op: remove path: /spec/template/spec/containers/1` |
| **Replace List Strategic Merge** | `containers: [name: haproxy, image: haproxy]` |
| **Add List Strategic Merge** | `containers: [name: haproxy, image: haproxy]` |
| **Delete List Strategic Merge** | `containers: [ $patch: delete, name: database]` |

---

# ğŸ¯ Best Practices for Kustomize Patches
| Best Practice | Description |
|--------------|-------------|
| **Use patches for surgical modifications** ğŸ”¬ | Avoid modifying entire YAML files when only a few fields need changes. |
| **Prefer Strategic Merge for common edits** ğŸ“Œ | Strategic merge patches are simpler and more readable for standard modifications. |
| **Use JSON 6902 for complex changes** ğŸ”§ | JSON patches allow fine-grained control over list-based resources. |
| **Keep patches organized** ğŸ“‚ | Store patches in separate files when they are large or reused across environments. |
| **Validate before applying** âœ… | Use `kubectl kustomize` to preview patched manifests before deploying. |
| **Use patches wisely with overlays** ğŸ¯ | Combine patches with overlays to simplify environment-specific changes. |
| **Avoid overusing patches** âŒ | Too many patches can make the configuration hard to read and maintain. |

---

# ğŸ“š CKA Exam Tips ğŸ“
âœ… **Know the difference between Strategic Merge and JSON 6902 patches.** <br/>
âœ… **Practice modifying resources using patches in different overlays.** <br/>
âœ… **Understand when to use patches vs. transformers.** <br/>
âœ… **Use `kubectl kustomize` to validate patches before applying.** <br/>
âœ… **Optimize YAML structures to avoid excessive patching.** <br/>
âœ… **Be prepared to modify resources dynamically in the exam.** <br/>
âœ… **Use `kubectl apply -k` instead of `kubectl apply -f` when working with kustomized resources.**<br/>



