# Kustomize Patches: A Detailed Guide 🚀

## 📌 Overview
Kustomize patches allow you to modify Kubernetes manifests in a **surgical** way without altering the base files. They help customize configurations dynamically for different environments.

## 🏗️ Types of Patches in Kustomize
| Patch Type | Description | Use Case |
|------------|-------------|----------|
| **Strategic Merge Patch** 🩹 | Uses the structure of the Kubernetes resource to apply modifications. | Best for modifying existing fields without affecting other fields. |
| **JSON 6902 Patch** 🔧 | Uses JSON patch syntax (`add`, `remove`, `replace`). | Useful for fine-grained control of specific elements. |
| **Inline Patch** ✏️ | Defined directly inside `kustomization.yaml`. | Best for small, quick modifications. |
| **Patch File** 📄 | Stored in a separate YAML file and referenced in `kustomization.yaml`. | Useful for larger or reusable patches. |

## ✅ When to Use Patches
- When you need **targeted modifications** without altering the original YAML files.
- When handling **environment-specific configurations** in overlays.
- When updating only **specific sections** of a resource.
- When avoiding **duplication** of Kubernetes manifests across different environments.

## ❌ When NOT to Use Patches
- If a **transformer** can achieve the modification (e.g., label changes, image updates).
- If the modification is **global** rather than targeted.
- If Helm provides a **better templating** alternative for the use case.

---

# 🔥 Practical Example: Using Patches in a Kind Cluster

## 📌 Step 1: Create a Kind Cluster 🏗️
```sh
cat <<EOF | kind create cluster --name=kustomize-patches --config=-
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
EOF
```

## 📌 Step 2: Setup Directory Structure 📂
```sh
mkdir -p kustomize-patches/base
mkdir -p kustomize-patches/overlays/dev
mkdir -p kustomize-patches/overlays/prod
```

## 📌 Step 3: Define Base Resources 📜
Create `kustomization.yaml` in `kustomize-patches/base/`:
```yaml
resources:
  - deployment.yaml
  - service.yaml
```

Create `deployment.yaml`:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.19
        ports:
        - containerPort: 80
```

## 📌 Step 4: Apply Different Patches 🎯

### ✅ Strategic Merge Patch Example 🩹
Create `kustomization.yaml` in `kustomize-patches/overlays/dev/`:
```yaml
bases:
  - ../../base
patchesStrategicMerge:
  - replicas-patch.yaml
```

Create `replicas-patch.yaml`:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 1
```

### ✅ JSON 6902 Patch Example 🔧
Create `kustomization.yaml` in `kustomize-patches/overlays/prod/`:
```yaml
bases:
  - ../../base
patches:
  - path: json-patch.yaml
    target:
      kind: Deployment
      name: nginx
```

Create `json-patch.yaml`:
```yaml
- op: replace
  path: /spec/replicas
  value: 5
```

## 📌 Step 5: Apply Kustomization 🚀
```sh
kubectl apply -k kustomize-patches/overlays/dev/
kubectl apply -k kustomize-patches/overlays/prod/
```

## 📌 Step 6: Verify Deployment 🔍
```sh
kubectl get deployments -o yaml | grep replicas
```

## 📌 Step 7: Clean Up 🗑️
```sh
kind delete cluster --name=kustomize-patches
```

---

# 🎯 Best Practices for Kustomize Patches
| Best Practice | Description |
|--------------|-------------|
| **Use patches for surgical modifications** 🔬 | Avoid modifying entire YAML files when only a few fields need changes. |
| **Prefer Strategic Merge for common edits** 📌 | Strategic merge patches are simpler and more readable for standard modifications. |
| **Use JSON 6902 for complex changes** 🔧 | JSON patches allow fine-grained control over list-based resources. |
| **Keep patches organized** 📂 | Store patches in separate files when they are large or reused across environments. |
| **Validate before applying** ✅ | Use `kubectl kustomize` to preview patched manifests before deploying. |

---

# 📚 CKA Exam Tips 🎓
✅ **Know the difference between Strategic Merge and JSON 6902 patches.**
✅ **Practice modifying resources using patches in different overlays.**
✅ **Understand when to use patches vs. transformers.**
✅ **Use `kubectl kustomize` to validate patches before applying.**
✅ **Optimize YAML structures to avoid excessive patching.**

