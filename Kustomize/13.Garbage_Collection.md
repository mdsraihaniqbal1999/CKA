# ğŸ—‘ï¸ **Garbage Collection in Kustomize** ğŸš€

## ğŸ“– Overview  
Garbage Collection (GC) in **Kustomize** is used to **clean up old, unused resources** when managing Kubernetes manifests. It prevents **orphaned objects** from persisting in the cluster when they are no longer defined in Kustomize.  

By default, Kustomize **does not** remove old resources. Instead, it **only applies changes** to existing resources. **Garbage Collection ensures that deleted resources in the manifest are also removed from the cluster.**  

---

## ğŸ¯ **Why Use Garbage Collection?**  
âœ… Automatically removes **unused resources** when they are removed from `kustomization.yaml`.  <br/>
âœ… Prevents **configuration drift** by ensuring the cluster matches the intended state.  <br/>
âœ… Reduces **manual cleanup effort**, making deployments more manageable.  <br/>
âœ… Useful for **managing dynamic workloads** where resources are frequently updated.  <br/>

---

## âŒ **When NOT to Use Garbage Collection?**  
âŒ If your resources need **manual control** and should not be deleted automatically.  <br/>
âŒ When using **imperative deployments** (`kubectl apply -f` without Kustomize).  <br/>
âŒ If **Helm** is managing resources, since Helm has its own release-based cleanup system.  <br/>

---

## ğŸ—ï¸ **How Garbage Collection Works in Kustomize?**  
| Concept | Description |
|---------|-------------|
| **Prune Feature (`--prune`)** ğŸŒ¿ | Removes resources no longer defined in the `kustomization.yaml`. |
| **Apply with `--prune`** ğŸ—ï¸ | Ensures only declared resources exist in the cluster. |
| **Labeling (`app.kubernetes.io/instance`)** ğŸ”– | Helps track resources and ensures only managed ones are pruned. |
| **Namespace-based GC** ğŸŒ | Helps remove resources based on namespaces. |

---

## ğŸ“‚ **Example Folder Structure**  
```sh
kustomize-gc/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”œâ”€â”€ overlays/
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”œâ”€â”€ prod/
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
```

---

## ğŸš€ **Step-by-Step Guide: Using Garbage Collection with a Kind Cluster**  

### ğŸ—ï¸ **Step 1: Create a Kind Cluster**
```sh
cat <<EOF | kind create cluster --name=kustomize-gc --config=-
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
EOF
```

---

## ğŸ“Œ **Step 2: Define Base Deployment (`deployment.yaml`)**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest
```

---

## âš™ï¸ **Step 3: Define `kustomization.yaml`**
```yaml
resources:
  - deployment.yaml
  - service.yaml

commonLabels:
  app.kubernetes.io/instance: nginx-app
```

---

## ğŸ”¥ **Step 4: Apply Resources Without Garbage Collection**
```sh
kubectl apply -k .
```
ğŸ”¹ **The resources will be created, but if you later remove one, it will not be deleted automatically.**  

---

## ğŸš€ **Step 5: Apply Resources with Garbage Collection (`--prune`)**
```sh
kubectl apply -k . --prune -l app.kubernetes.io/instance=nginx-app
```
ğŸ”¹ **This ensures that any removed resource from `kustomization.yaml` will also be deleted in the cluster.**  

---

## ğŸ” **Step 6: Verify the Resources**
```sh
kubectl get all -l app.kubernetes.io/instance=nginx-app
```
ğŸ”¹ **This shows only resources managed by Kustomize, helping track what will be pruned.**  

---

## âš¡ **Best Practices for Garbage Collection in Kustomize**
| Best Practice | Description |
|--------------|-------------|
| **Always use labels for tracking** ğŸ”– | Use `app.kubernetes.io/instance` to tag resources properly. |
| **Enable `--prune` carefully** âš ï¸ | Ensure you have backups before pruning critical resources. |
| **Combine with overlays for environment-specific cleanup** ğŸŒ | Keep separate `kustomization.yaml` files for `dev`, `staging`, and `prod`. |
| **Test `kubectl apply -k . --prune --dry-run=client` before applying** ğŸ› ï¸ | Prevent accidental deletions. |
| **Use `kubectl get all --selector=<label>` to verify before pruning** ğŸ” | Avoid deleting unintended resources. |

---

## ğŸ“ **CKA Exam Tips**
âœ… **Understand how `--prune` works and when to use it.** <br/>
âœ… **Practice applying Kustomize manifests and removing resources dynamically.** <br/> 
âœ… **Use `kubectl apply -k . --prune` with labels to target specific resources.**  <br/>
âœ… **Know how to filter resources using `kubectl get all -l <label>`.**  <br/>
âœ… **Be careful with pruningâ€”test with `--dry-run=client` before applying.**  <br/>

---

